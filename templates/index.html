<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Main</title>
  <style>
    .base {
      display: flex;
    }

    .elem {
      padding: 15px;
      width: 33%;
    }

    .block {
      padding: 15px;
      margin: 15px;
      border-radius: 15px;
    }

    .trade {
      background-color: beige;
    }

    .fee {
      background-color: azure;
      border-radius: 5px;
      font-size: small;
    }

    .action {
      background-color: burlywood;
    }

    .alert {
      background-color: lightcoral;
    }

    .modal {
      background-color: aqua;
      opacity: 30%;
      position: fixed;
      left: 30%;
      top: 30px;
      color: black;
      font-size: large;
      font-weight: bolder;
      padding: 20px;
    }

    .confirm-modal {
      background-color: coral;
      opacity: 90%;
      position: fixed;
      left: 30%;
      top: 30px;
      color: black;
      font-size: large;
      font-weight: bold;
      padding: 20px;
    }

    .hidden {
      display: none;
    }
  </style>

  
</head>
<body class="base">
  {% if not auth %}

    <form action="/pass" method="post">
      <label for="s">–ü–∞—Ä–æ–ª—å</label>
      <input type="text" name="s">
      <button type="submit">–í–æ–π—Ç–∏</button>
    </form>
  {% endif %}
  {% if auth %}
    <div class="modal hidden" id="modal">
      {% if found_tickers and f.len(found_tickers) == 1 %}
      –£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ 
      <br>
      –¢–∏–∫–µ—Ä: {{ found_tickers[0].ticker }}
      <br>
      –ù–∞–∑–≤–∞–Ω–∏–µ: {{ found_tickers[0].name }}
      {% endif %}
    </div>
    <div class="elem">
      
      {% if (bot_working) %}
      <h1>–ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç</h1>
      {% else %}
      <h1>–ë–æ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç</h1>
      {% endif %}
        <form action="/change" method="post">
          <button type="submit">
            –í—ã–∫–ª—é—á–∏—Ç—å/–í–∫–ª—é—á–∏—Ç—å
          </button>
        </form>
      {% if (inverted) %}
      <h1>–ë–æ—Ç –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω</h1>
      {% else %}
      <h1>–ë–æ—Ç –Ω–µ –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω</h1>
      {% endif %}
      <form action="/change_inv" method="post">
        <button type="submit">
          –ò–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
        </button>
      </form>
      
      <div class="block">
        <form action="/change_q" method="post">
          <label for="q">–õ–æ—Ç: </label>
          <input type="text" value="{{q_limit}}" name="q">
          <button type="submit">
            –ò–∑–º–µ–Ω–∏—Ç—å –ª–æ—Ç
          </button>
        </form>
      </div>

        <h3>–†–∞–±–æ—Ç–∞–µ—Ç –ø–æ –≤—Ä–µ–º–µ–Ω–∏: {{ "–î–∞" if work_on_time else "–ù–µ—Ç" }}</h3>
        <form action="/change_work_on_time" method="post">
          <button type="submit">
            {{ "–í—ã–∫–ª—é—á–∏—Ç—å" if work_on_time else "–í–∫–ª—é—á–∏—Ç—å" }}
          </button>
        </form>
        <form action="/change_time" method="post">
          <p>
            <label for="ts">–ù–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞: </label>
            <input type="time" name="ts" value="{{ time_start }}">
          </p>
          <p>
          <label for="te">–ö–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞: </label>
          <input type="time" name="te" value="{{ time_end }}">
          </p>
          <button type="submit">
            –ò–∑–º–µ–Ω–∏—Ç—å –ø–µ—Ä–∏–æ–¥
          </button>
        </form>
      <br>
      <form action="/change_k" method="post">
        –¢–æ—Ä–≥—É–µ—Ç: 
        <select name="k">
          {% for i in figis.keys() %}
            <option value="{{figis.get(i)}}"
            {% if i == figi_name %}
            selected
            {%endif%}
            >{{i}}</option>
          {% endfor %}
        </select>
        <button type="submit">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
      </form>
      {% if (piramid) %}
      <h1>–ü–∏—Ä–∞–º–∏–¥–∏–Ω–≥ –≤–∫–ª—é—á–µ–Ω</h1>
      {% else %}
      <h1>–ü–∏—Ä–∞–º–∏–¥–∏–Ω–≥ –≤—ã–∫–ª—é—á–µ–Ω</h1>
      {% endif %}
        <form action="/change_pir" method="post">
          <button type="submit">
            –í–∫–ª/–í—ã–∫–ª
          </button>
        </form>
      {% if piramid %}

      <div class="block" style="background-color: aliceblue;">
        <form action="/change_max_am" method="post">
          <label for="maxam">–õ–æ—Ç: </label>
          <input type="text" value="{{maxam}}" name="maxam">
          
          <button type="submit" style="margin-top: 10px;">
            –ò–∑–º–µ–Ω–∏—Ç—å –º–∞–∫—Å–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏
          </button>
        </form>
      </div>

      {% endif %}

      {% if (stop_loss) %}
      <h1>–°—Ç–æ–ø-–ª–æ—Å—Å –≤–∫–ª—é—á–µ–Ω</h1>
      {% else %}
      <h1>–°—Ç–æ–ø-–ª–æ—Å—Å –≤—ã–∫–ª—é—á–µ–Ω</h1>
      {% endif %}
        <form action="/change_stop_loss" method="post">
          <button type="submit">
            –í–∫–ª/–í—ã–∫–ª
          </button>
        </form>
      {% if stop_loss %}

      <div class="block" style="background-color: aliceblue;">
        <form action="/change_stop_loss_diff" method="post">
          <label for="diff">–†–∞–∑–º–µ—Ä —Å—Ç–æ–ø-–ª–æ—Å—Å–∞: </label>
          <input type="text" value="{{stop_loss_diff}}" name="diff">
          
          <button type="submit" style="margin-top: 10px;">
            –ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä —Å—Ç–æ–ø-–ª–æ—Å—Å–∞
          </button>
        </form>
      </div>

      <div class="block" style="background-color: aliceblue;">
        {% if stop_loss_closes_position %}
        <h3>–°—Ç–æ–ø-–ª–æ—Å—Å –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é</h3>
        {% else %}
        <h3>–°—Ç–æ–ø-–ª–æ—Å—Å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—É—é –ø–æ–∑–∏—Ü–∏—é</h3>
        {% endif %}
        <form action="/change_stop_loss_closes_position" method="post">
          <button type="submit">
            –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å
          </button>
        </form>
      </div>

      {% endif %}
      <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–æ—Ç–∏—Ä–æ–∫—É</h3>
      <form action="/add_k" method="post" id="add_k">
        <label for="ticker">–¢–∏–∫–µ—Ä: </label>
        <input type="text" name="ticker" id="add_k__ticker" value="{{ add_ticker if add_ticker }}">
        <br>
        <label for="type">–¢–∏–ø –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞</label>
        <select name="type">
          <option value="share"
            {% if selected_type == "share" %}
            selected
            {% endif %}
          >–ê–∫—Ü–∏—è</option>
          <option value="futures"
            {% if selected_type == "futures" %}
            selected
            {% endif %}
          >–§—å—é—á–µ—Ä—Å</option>
        </select>
        <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
      </form>
      <br>
      {% if found_tickers and f.len(found_tickers) > 1 %}
        <form action="/exit_add_k" method="post">
          <button id="add_k_close">–ó–∞–≤–µ—Ä—à–∏—Ç—å –ø–æ–∏—Å–∫</button>
        </form>
      {% endif %}
      <div class="block" id="add_k_result">
        {% if found_tickers and f.len(found_tickers) > 1 %}
          {% if f.len(found_tickers) > 7 %}
          –†–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ, —É–∫–∞–∂–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–µ–µ
          {% endif %}
          {% for i in found_tickers %}
            <br>
            <h4>–¢–∏–∫–µ—Ä: {{ i.ticker }}</h4>
            <h4>–ù–∞–∑–≤–∞–Ω–∏–µ: {{ i.name }}</h4>
  
            <h4>–¢–∏–ø: 
              {% if i.instrument_type == "futures" %}
              –§—å—é—á–µ—Ä—Å
              {% elif i.instrument_type == "share" %}
              –ê–∫—Ü–∏—è
              {% else %}
              {{ i.instrument_type }}
              {% endif %}
            </h4>
          {% endfor %}
        {% endif %}
      </div>
      <h2>–ë–æ—Ç –∑–∞—Ä–∞–±–æ—Ç–∞–ª –∑–∞ —ç—Ç—É –Ω–µ–¥–µ–ª—é: {{ f.round(result, 2) }}</h2>
      
      <div class="block" style="background-color: #e8f5e8; border: 1px solid #c3e6cb;">
        <h3>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h3>
        <p><a href="/performance" style="color: #155724; text-decoration: none; font-weight: bold;">
          üìà –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º
        </a></p>
        <p style="font-size: 0.9em; color: #666; margin-top: 5px;">
          –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π –ø–æ –Ω–µ–¥–µ–ª—è–º –∏ –º–µ—Å—è—Ü–∞–º
        </p>
      </div>
      
      <h1>–ü–æ—Ä—Ç—Ñ–µ–ª—å:</h1>
      -----------
      <br>
      <h1>–°—É–º–º–∞: {{ f.round(q2f(portfolio.total_amount_shares) + q2f(portfolio.total_amount_currencies))}} —Ä—É–±</h1>
      <h2>–ê–∫—Ü–∏–π –Ω–∞ {{q2f(portfolio.total_amount_shares)}} {{ portfolio.total_amount_shares.currency }}</h2>
      <h2>–í–∞–ª—é—Ç—ã –Ω–∞ {{q2f(portfolio.total_amount_currencies)}} {{ portfolio.total_amount_shares.currency }}</h2>
      <h2>–§—å—é—á–µ—Ä—Å–æ–≤ –Ω–∞ {{q2f(portfolio.total_amount_futures)}} {{ portfolio.total_amount_shares.currency }}</h2>
      ------------
      <br>
      <h2>–ü–æ–∑–∏—Ü–∏–∏ –ø–æ—Ä—Ç—Ñ–µ–ª—è: </h2>
      {%for i in portfolio.positions%}
        =====================
        <br>
        <h3>
          {% if figis2.get(i.figi) %}
            –ü–æ–∑–∏—Ü–∏—è: {{ figis2.get(i.figi) }}
          {% else %}
            FIGI: {{ i.figi }}
          {% endif %}
        </h3>
          {% if i.instrument_type == "currency" %}
          <h3>–¢–∏–ø: –≤–∞–ª—é—Ç–∞</h3>
        {% elif i.instrument_type == "share" %}
          <h3>–¢–∏–ø: –∞–∫—Ü–∏—è</h3>
        {% elif i.instrument_type == "futures" %}
          <h3>–¢–∏–ø: —Ñ—å—é—á–µ—Ä—Å</h3>
        {% endif %}
        {% if i.instrument_type == "currency" %}
        <h3>–°—É–º–º–∞: {{ f.round(q2f(i.quantity), 2) }} </h3>
        {% else %}
        <h3>–°—É–º–º–∞: {{ f.round(q2f(i.quantity) * q2f(i.current_price),2) }} {{ i.current_price.currency }}</h3>
        {% endif %}
      {%endfor%}
    </div>
  
    <div class="elem">
      {% if f.len(trades) == 0 %}
      <h3>–ù–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Å–¥–µ–ª–æ–∫</h3>
      {% endif %}
      {% for trade in trades %}
        <div class="trade block">
          ‚Ññ {{ trade.num }}
          <h3>–í—Ä–µ–º—è –ø–æ–∫—É–ø–∫–∏: {{ trade.timeStart }}  –ø–æ  {{ f.round(trade.pt1, 3) }}</h3>
          <h3>–í—Ä–µ–º—è –ø—Ä–æ–¥–∞–∂–∏: {{ trade.timeEnd }}   –ø–æ  {{ f.round(trade.pt2, 3) }}</h3>
          <h3>–¢–∏–ø: {{ trade.type }}</h3>
          <h3> 
            {% if figis2.get(trade.figi) %}
            –ü–æ–∑–∏—Ü–∏—è: {{ figis2.get(trade.figi) }}
            {% else %}
              FIGI: {{ trade.figi }}
            {% endif %}
          </h3>
          <h3>–û–±—ä–µ–º: {{ trade.quantity }}</h3>
          <h3>–ó–∞—Ä–∞–±–æ—Ç–æ–∫: {{ f.round(trade.result, 2) }}</h3>
        </div>
      {% endfor %}
    </div>
    
    <div class="elem"> 
      <form action="/change_num_trades" method="post">
        <label for="num">–í—ã–≤–µ—Å—Ç–∏ —Å–¥–µ–ª–∫–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ ____ –¥–Ω–µ–π</label>
        <input type="number" name="num" value="{{ settings.num_trades }}">
        <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </form>
      <form style="margin-top: 15px;" action="/make_trade" method="post" id="makeTradeForm">
        <select name="trade" id="trade">
          <option value="buy">–ö—É–ø–∏—Ç—å</option>
          <option value="sell">–ü—Ä–æ–¥–∞—Ç—å</option>
          <option value="close">–ó–∞–∫—Ä—ã—Ç—å –ø–æ–∑–∏—Ü–∏—é</option>
        </select>
        <button id="trySubmitButton">–°–æ–≤–µ—Ä—à–∏—Ç—å —Å–¥–µ–ª–∫—É</button>
        <div class="hidden" id="confirmTrade">
          <p>–£–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ <span id="tradeTypeText"></span>?</p>
          <button type="submit">–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–æ–π—Ç–∏ –≤ –ø–æ–∑–∏—Ü–∏—é</button>
          <button id="closeTrade">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
        </div>
      </form>
      <form style="margin-top: 15px;" action="/change_show_all_trades" method="post">
        <button type="submit">
          {% if show_all_trades %}
          –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Å–¥–µ–ª–∫–∏ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ª–æ—Ç–Ω–æ—Å—Ç–∏
          {% else %}
          –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Å–¥–µ–ª–∫–∏
          {% endif %}
        </button>
      </form>
      {% if unsuccessful_trade %}
      <div class="block alert">
        <h3>–°–¥–µ–ª–∫–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏—Å–ø–æ–ª–Ω–µ–Ω–∞ –≤ —Å–≤—è–∑–∏ —Å –æ—à–∏–±–∫–æ–π. –ü–æ–ø—ã—Ç–∫–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø—Ä–æ–≤–æ–¥—è—Ç—Å—è –≤ –∞–≤—Ç–æ-—Ä–µ–∂–∏–º–µ</h3>
        <h3>–°–∏–≥–Ω–∞–ª: {{ unsuccessful_trade }}</h3>
        <p>–û—à–∏–±–∫–∞: {{ error }}</p>
        <form action="/break_waiting" method="get">
          <button type="submit">–û—Ç–º–µ–Ω–∏—Ç—å —Å–¥–µ–ª–∫—É</button>
        </form>
      </div>
      {% endif %}
      {% for order in orders.operations %}
        {% if (settings.show_fees or (order.type != '–£–¥–µ—Ä–∂–∞–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏–∏ –∑–∞ –æ–ø–µ—Ä–∞—Ü–∏—é' and order.type != '–°–ø–∏—Å–∞–Ω–∏–µ –≤–∞—Ä–∏–∞—Ü–∏–æ–Ω–Ω–æ–π –º–∞—Ä–∂–∏')) %}
          <div class="block
          {% if order.type != '–£–¥–µ—Ä–∂–∞–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏–∏ –∑–∞ –æ–ø–µ—Ä–∞—Ü–∏—é' and order.type != '–°–ø–∏—Å–∞–Ω–∏–µ –≤–∞—Ä–∏–∞—Ü–∏–æ–Ω–Ω–æ–π –º–∞—Ä–∂–∏' and order.type != '–ó–∞—á–∏—Å–ª–µ–Ω–∏–µ –≤–∞—Ä–∏–∞—Ü–∏–æ–Ω–Ω–æ–π –º–∞—Ä–∂–∏'%}
          action
          {% else %}
          fee 
          {% endif %}
          ">
            <h3>–û–ø–µ—Ä–∞—Ü–∏—è: {{ order.type }}</h3>
            {% if order.type != '–£–¥–µ—Ä–∂–∞–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏–∏ –∑–∞ –æ–ø–µ—Ä–∞—Ü–∏—é' and order.type != '–°–ø–∏—Å–∞–Ω–∏–µ –≤–∞—Ä–∏–∞—Ü–∏–æ–Ω–Ω–æ–π –º–∞—Ä–∂–∏' and order.type != '–ó–∞—á–∏—Å–ª–µ–Ω–∏–µ –≤–∞—Ä–∏–∞—Ü–∏–æ–Ω–Ω–æ–π –º–∞—Ä–∂–∏' %}
            <h3> 
              {% if figis2.get(order.figi) %}
              –ü–æ–∑–∏—Ü–∏—è: {{ figis2.get(order.figi) }}
              {% else %}
                FIGI: {{ order.figi }}
              {% endif %}
            </h3>
            {%endif%}
            {% if (order.payment.nano|string)[0] != '-' %}
            <h3>–°—É–º–º–∞: {{ q2f(order.payment) }} {{order.payment.currency}}</h3>
            {% else %}
            <h3>–°—É–º–º–∞: {{ (order.payment.units|string + "." + (order.payment.nano|string)[1:3]) }} {{order.payment.currency}}</h3>
            {% endif %}
            {% if order.price.units != 0 %}
            <h3>–¶–µ–Ω–∞ –ø–æ–∑–∏—Ü–∏–∏: {{ q2f(order.price) }} {{order.price.currency}}</h3>
            <h3>–û–±—ä–µ–º —Å–¥–µ–ª–∫–∏: {{ order.quantity }}</h3>
            {% endif %}
            <h3>–î–∞—Ç–∞: {{ f.correct_timezone(order.date).strftime("%Y-%m-%d %H:%M") }}</h3>
         </div>
  
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}
  
  <script>
    const form = document.getElementById("add_k")
    const inp = document.getElementById("add_k__ticker")
    const modal = document.getElementById("modal")
    const trySubmitButton = document.getElementById("trySubmitButton")
    const confirmTrade = document.getElementById("confirmTrade")
    const closeTradeButton = document.getElementById("closeTrade")
    const tradeTypeText = document.getElementById("tradeTypeText")


    form.onsubmit = (ev) => {
      if (inp.value == "") {
        ev.preventDefault()
      }
    }

    trySubmitButton.onclick = (ev) => {
      ev.preventDefault()
      confirmTrade.classList = "confirm-modal"
      const trade = document.getElementById("trade")
      tradeTypeText.textContent = trade.options[trade.selectedIndex].text.toLowerCase()
    }

    closeTradeButton.onclick = (ev) => {
      ev.preventDefault()
      confirmTrade.classList = "hidden"
    }

    {% if found_tickers and f.len(found_tickers) == 1 %}
      modal.classList = "modal"
      setTimeout(() => {
        modal.classList = "modal hidden"
      }, 8000)
    {% else %}
      modal.classList = "modal hidden"
    {% endif %}

  </script>
</body>
</html>